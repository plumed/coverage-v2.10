<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - plumed test coverage - mapping/PCAVars.cpp</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">mapping</a> - PCAVars.cpp<span style="font-size: 80%;"> (source / <a href="PCAVars.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">plumed test coverage</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">86</td>
            <td class="headerCovTableEntry">89</td>
            <td class="headerCovTableEntryHi">96.6 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2024-10-23 18:13:10</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">2</td>
            <td class="headerCovTableEntry">3</td>
            <td class="headerCovTableEntryLo">66.7 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</a>
<a name="2"><span class="lineNum">       2 </span>            :    Copyright (c) 2013-2018 The plumed team</a>
<a name="3"><span class="lineNum">       3 </span>            :    (see the PEOPLE file at the root of the distribution for a list of names)</a>
<a name="4"><span class="lineNum">       4 </span>            : </a>
<a name="5"><span class="lineNum">       5 </span>            :    See http://www.plumed.org for more information.</a>
<a name="6"><span class="lineNum">       6 </span>            : </a>
<a name="7"><span class="lineNum">       7 </span>            :    This file is part of plumed, version 2.</a>
<a name="8"><span class="lineNum">       8 </span>            : </a>
<a name="9"><span class="lineNum">       9 </span>            :    plumed is free software: you can redistribute it and/or modify</a>
<a name="10"><span class="lineNum">      10 </span>            :    it under the terms of the GNU Lesser General Public License as published by</a>
<a name="11"><span class="lineNum">      11 </span>            :    the Free Software Foundation, either version 3 of the License, or</a>
<a name="12"><span class="lineNum">      12 </span>            :    (at your option) any later version.</a>
<a name="13"><span class="lineNum">      13 </span>            : </a>
<a name="14"><span class="lineNum">      14 </span>            :    plumed is distributed in the hope that it will be useful,</a>
<a name="15"><span class="lineNum">      15 </span>            :    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="16"><span class="lineNum">      16 </span>            :    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="17"><span class="lineNum">      17 </span>            :    GNU Lesser General Public License for more details.</a>
<a name="18"><span class="lineNum">      18 </span>            : </a>
<a name="19"><span class="lineNum">      19 </span>            :    You should have received a copy of the GNU Lesser General Public License</a>
<a name="20"><span class="lineNum">      20 </span>            :    along with plumed.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="21"><span class="lineNum">      21 </span>            : +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */</a>
<a name="22"><span class="lineNum">      22 </span>            : #include &quot;core/ActionShortcut.h&quot;</a>
<a name="23"><span class="lineNum">      23 </span>            : #include &quot;core/ActionRegister.h&quot;</a>
<a name="24"><span class="lineNum">      24 </span>            : #include &quot;core/PlumedMain.h&quot;</a>
<a name="25"><span class="lineNum">      25 </span>            : #include &quot;core/ActionWithArguments.h&quot;</a>
<a name="26"><span class="lineNum">      26 </span>            : #include &quot;tools/PDB.h&quot;</a>
<a name="27"><span class="lineNum">      27 </span>            : #include &quot;Path.h&quot;</a>
<a name="28"><span class="lineNum">      28 </span>            : </a>
<a name="29"><span class="lineNum">      29 </span>            : namespace PLMD {</a>
<a name="30"><span class="lineNum">      30 </span>            : namespace mapping {</a>
<a name="31"><span class="lineNum">      31 </span>            : </a>
<a name="32"><span class="lineNum">      32 </span>            : //+PLUMEDOC COLVAR PCAVARS</a>
<a name="33"><span class="lineNum">      33 </span>            : /*</a>
<a name="34"><span class="lineNum">      34 </span>            : Projection on principal component eigenvectors or other high dimensional linear subspace</a>
<a name="35"><span class="lineNum">      35 </span>            : </a>
<a name="36"><span class="lineNum">      36 </span>            : The collective variables described in \ref dists allow one to calculate the distance between the</a>
<a name="37"><span class="lineNum">      37 </span>            : instantaneous structure adopted by the system and some high-dimensional, reference configuration.  The</a>
<a name="38"><span class="lineNum">      38 </span>            : problem with doing this is that, as one gets further and further from the reference configuration, the</a>
<a name="39"><span class="lineNum">      39 </span>            : distance from it becomes a progressively poorer and poorer collective variable.  This happens because</a>
<a name="40"><span class="lineNum">      40 </span>            : the ``number&quot; of structures at a distance \f$d\f$ from a reference configuration is proportional to \f$d^N\f$ in</a>
<a name="41"><span class="lineNum">      41 </span>            : an \f$N\f$ dimensional space.  Consequently, when \f$d\f$ is small the distance from the reference configuration</a>
<a name="42"><span class="lineNum">      42 </span>            : may well be a good collective variable.  However, when \f$d\f$ is large it is unlikely that the distance from the reference</a>
<a name="43"><span class="lineNum">      43 </span>            : structure is a good CV.  When the distance is large there will almost certainly be markedly different</a>
<a name="44"><span class="lineNum">      44 </span>            : configuration that have the same CV value and hence barriers in transverse degrees of</a>
<a name="45"><span class="lineNum">      45 </span>            : freedom.</a>
<a name="46"><span class="lineNum">      46 </span>            : </a>
<a name="47"><span class="lineNum">      47 </span>            : For these reasons dimensionality reduction is often employed so a projection \f$\mathbf{s}\f$ of a high-dimensional configuration</a>
<a name="48"><span class="lineNum">      48 </span>            : \f$\mathbf{X}\f$ in a lower dimensionality space using a function:</a>
<a name="49"><span class="lineNum">      49 </span>            : </a>
<a name="50"><span class="lineNum">      50 </span>            : \f[</a>
<a name="51"><span class="lineNum">      51 </span>            : \mathbf{s} = F(\mathbf{X}-\mathbf{X}^{ref})</a>
<a name="52"><span class="lineNum">      52 </span>            : \f]</a>
<a name="53"><span class="lineNum">      53 </span>            : </a>
<a name="54"><span class="lineNum">      54 </span>            : where here we have introduced some high-dimensional reference configuration \f$\mathbf{X}^{ref}\f$.  By far the simplest way to</a>
<a name="55"><span class="lineNum">      55 </span>            : do this is to use some linear operator for \f$F\f$.  That is to say we find a low-dimensional projection</a>
<a name="56"><span class="lineNum">      56 </span>            : by rotating the basis vectors using some linear algebra:</a>
<a name="57"><span class="lineNum">      57 </span>            : </a>
<a name="58"><span class="lineNum">      58 </span>            : \f[</a>
<a name="59"><span class="lineNum">      59 </span>            : \mathbf{s}_i = \sum_k A_{ik} ( X_{k} - X_{k}^{ref} )</a>
<a name="60"><span class="lineNum">      60 </span>            : \f]</a>
<a name="61"><span class="lineNum">      61 </span>            : </a>
<a name="62"><span class="lineNum">      62 </span>            : Here \f$A\f$ is a \f$d\f$ by \f$D\f$ matrix where \f$D\f$ is the dimensionality of the high dimensional space and \f$d\f$ is</a>
<a name="63"><span class="lineNum">      63 </span>            : the dimensionality of the lower dimensional subspace.  In plumed when this kind of projection you can use the majority</a>
<a name="64"><span class="lineNum">      64 </span>            : of the metrics detailed on \ref dists to calculate the displacement, \f$\mathbf{X}-\mathbf{X}^{ref}\f$, from the reference configuration.</a>
<a name="65"><span class="lineNum">      65 </span>            : The matrix \f$A\f$ can be found by various means including principal component analysis and normal mode analysis.  In both these methods the</a>
<a name="66"><span class="lineNum">      66 </span>            : rows of \f$A\f$ would be the principle eigenvectors of a square matrix.  For PCA the covariance while for normal modes the Hessian.</a>
<a name="67"><span class="lineNum">      67 </span>            : </a>
<a name="68"><span class="lineNum">      68 </span>            : \bug It is not possible to use the \ref DRMSD metric with this variable.  You can get around this by listing the set of distances you wish to calculate for your DRMSD in the plumed file explicitly and using the EUCLIDEAN metric.  MAHALONOBIS and NORM-EUCLIDEAN also do not work with this variable but using these options makes little sense when projecting on a linear subspace.</a>
<a name="69"><span class="lineNum">      69 </span>            : </a>
<a name="70"><span class="lineNum">      70 </span>            : \par Examples</a>
<a name="71"><span class="lineNum">      71 </span>            : </a>
<a name="72"><span class="lineNum">      72 </span>            : The following input calculates a projection on a linear subspace where the displacements</a>
<a name="73"><span class="lineNum">      73 </span>            : from the reference configuration are calculated using the OPTIMAL metric.  Consequently,</a>
<a name="74"><span class="lineNum">      74 </span>            : both translation of the center of mass of the atoms and rotation of the reference</a>
<a name="75"><span class="lineNum">      75 </span>            : frame are removed from these displacements.  The matrix \f$A\f$ and the reference</a>
<a name="76"><span class="lineNum">      76 </span>            : configuration \f$R^{ref}\f$ are specified in the pdb input file reference.pdb and the</a>
<a name="77"><span class="lineNum">      77 </span>            : value of all projections (and the residual) are output to a file called colvar2.</a>
<a name="78"><span class="lineNum">      78 </span>            : </a>
<a name="79"><span class="lineNum">      79 </span>            : \plumedfile</a>
<a name="80"><span class="lineNum">      80 </span>            : PCAVARS REFERENCE=reference.pdb TYPE=OPTIMAL LABEL=pca2</a>
<a name="81"><span class="lineNum">      81 </span>            : PRINT ARG=pca2.* FILE=colvar2</a>
<a name="82"><span class="lineNum">      82 </span>            : \endplumedfile</a>
<a name="83"><span class="lineNum">      83 </span>            : </a>
<a name="84"><span class="lineNum">      84 </span>            : The reference configurations can be specified using a pdb file.  The first configuration that you provide is the reference configuration,</a>
<a name="85"><span class="lineNum">      85 </span>            : which is referred to in the above as \f$X^{ref}\f$ subsequent configurations give the directions of row vectors that are contained in</a>
<a name="86"><span class="lineNum">      86 </span>            : the matrix \f$A\f$ above.  These directions are specified by giving a second configuration that describes the components of \f$A\f$ explicitly.</a>
<a name="87"><span class="lineNum">      87 </span>            : </a>
<a name="88"><span class="lineNum">      88 </span>            : \verbatim</a>
<a name="89"><span class="lineNum">      89 </span>            : ATOM      2  CH3 ACE     1      12.932 -14.718  -6.016  1.00  1.00</a>
<a name="90"><span class="lineNum">      90 </span>            : ATOM      5  C   ACE     1      21.312  -9.928  -5.946  1.00  1.00</a>
<a name="91"><span class="lineNum">      91 </span>            : ATOM      9  CA  ALA     2      19.462 -11.088  -8.986  1.00  1.00</a>
<a name="92"><span class="lineNum">      92 </span>            : ATOM     13  HB2 ALA     2      21.112 -10.688 -12.476  1.00  1.00</a>
<a name="93"><span class="lineNum">      93 </span>            : ATOM     15  C   ALA     2      19.422   7.978 -14.536  1.00  1.00</a>
<a name="94"><span class="lineNum">      94 </span>            : ATOM     20 HH31 NME     3      20.122  -9.928 -17.746  1.00  1.00</a>
<a name="95"><span class="lineNum">      95 </span>            : ATOM     21 HH32 NME     3      18.572 -13.148 -16.346  1.00  1.00</a>
<a name="96"><span class="lineNum">      96 </span>            : END</a>
<a name="97"><span class="lineNum">      97 </span>            : REMARK</a>
<a name="98"><span class="lineNum">      98 </span>            : ATOM      2  CH3 ACE     1      0.1414  0.3334 -0.0302  1.00  0.00</a>
<a name="99"><span class="lineNum">      99 </span>            : ATOM      5  C   ACE     1      0.0893 -0.1095 -0.1434  1.00  0.00</a>
<a name="100"><span class="lineNum">     100 </span>            : ATOM      9  CA  ALA     2      0.0207 -0.321   0.0321  1.00  0.00</a>
<a name="101"><span class="lineNum">     101 </span>            : ATOM     13  HB2 ALA     2      0.0317 -0.6085  0.0783  1.00  0.00</a>
<a name="102"><span class="lineNum">     102 </span>            : ATOM     15  C   ALA     2      0.1282 -0.4792  0.0797  1.00  0.00</a>
<a name="103"><span class="lineNum">     103 </span>            : ATOM     20 HH31 NME     3      0.0053 -0.465   0.0309  1.00  0.00</a>
<a name="104"><span class="lineNum">     104 </span>            : ATOM     21 HH32 NME     3     -0.1019 -0.4261 -0.0082  1.00  0.00</a>
<a name="105"><span class="lineNum">     105 </span>            : END</a>
<a name="106"><span class="lineNum">     106 </span>            : \endverbatim</a>
<a name="107"><span class="lineNum">     107 </span>            : </a>
<a name="108"><span class="lineNum">     108 </span>            : Notice that the PCAVARS command is a shortcut.  If you look at how the shortcut in the above input is expanded you should be able to see how the command works</a>
<a name="109"><span class="lineNum">     109 </span>            : by calculating the RMSD displacement between the instantaneous and reference configuration and how those displacements are then projected on the eigenvector that</a>
<a name="110"><span class="lineNum">     110 </span>            : was specified in the second frame of the pdb input above. Understanding the expanded version of this shortcut command allows you to recognise that you can project</a>
<a name="111"><span class="lineNum">     111 </span>            : the displacement vector on any arbitrary vector.  For example in the input below two reference structures are provided in the pdb file. PLUMED calculates the RMSD</a>
<a name="112"><span class="lineNum">     112 </span>            : distance between these two reference configurations during setup and sets up a unit vector called eig that points along the director connecting the two RMSD structure.</a>
<a name="113"><span class="lineNum">     113 </span>            : During the calculation the vector connecting the instantaneous configuration and the first of the two reference configurations in computed.  This vector is then projected</a>
<a name="114"><span class="lineNum">     114 </span>            : on the unit vector connecting the two initial structures:</a>
<a name="115"><span class="lineNum">     115 </span>            : </a>
<a name="116"><span class="lineNum">     116 </span>            : \plumedfile</a>
<a name="117"><span class="lineNum">     117 </span>            : # Read in two reference configuratioms from PDB file</a>
<a name="118"><span class="lineNum">     118 </span>            : ref1: PDB2CONSTANT REFERENCE=two-frames.pdb NUMBER=1</a>
<a name="119"><span class="lineNum">     119 </span>            : ref1T: TRANSPOSE ARG=ref1</a>
<a name="120"><span class="lineNum">     120 </span>            : ref2: PDB2CONSTANT REFERENCE=two-frames.pdb NUMBER=2</a>
<a name="121"><span class="lineNum">     121 </span>            : # Calculate the displacement vector that takes you from ref1 to ref2</a>
<a name="122"><span class="lineNum">     122 </span>            : eigu: RMSD_VECTOR ARG=ref1T,ref2 DISPLACEMENT TYPE=OPTIMAL</a>
<a name="123"><span class="lineNum">     123 </span>            : # Normalise the reference vector</a>
<a name="124"><span class="lineNum">     124 </span>            : eigu2: CUSTOM ARG=eigu.disp FUNC=x*x PERIODIC=NO</a>
<a name="125"><span class="lineNum">     125 </span>            : eign2: SUM ARG=eigu2 PERIODIC=NO</a>
<a name="126"><span class="lineNum">     126 </span>            : eig: CUSTOM ARG=eigu.disp,eign2 FUNC=x/sqrt(y) PERIODIC=NO</a>
<a name="127"><span class="lineNum">     127 </span>            : eigT: TRANSPOSE ARG=eig</a>
<a name="128"><span class="lineNum">     128 </span>            : # Everything prior to this point is only done in setup.  From here onwards we have the commands that are done during the main calculate loop.</a>
<a name="129"><span class="lineNum">     129 </span>            : </a>
<a name="130"><span class="lineNum">     130 </span>            : # Calculate the RMSD displacement between the instaneous structure and the first reference structure</a>
<a name="131"><span class="lineNum">     131 </span>            : rmsd: RMSD REFERENCE=two-frames.pdb NUMBER=1 TYPE=OPTIMAL DISPLACEMENT SQUARED</a>
<a name="132"><span class="lineNum">     132 </span>            : # Project the displacement computed above on the director of the vector that connects reference structure ref1 to refeference structure ref2</a>
<a name="133"><span class="lineNum">     133 </span>            : pca: MATRIX_VECTOR_PRODUCT ARG=eigT,rmsd.disp</a>
<a name="134"><span class="lineNum">     134 </span>            : </a>
<a name="135"><span class="lineNum">     135 </span>            : # Print the final CV to a file</a>
<a name="136"><span class="lineNum">     136 </span>            : PRINT ARG=pca FILE=colvar</a>
<a name="137"><span class="lineNum">     137 </span>            : \endplumedfile</a>
<a name="138"><span class="lineNum">     138 </span>            : </a>
<a name="139"><span class="lineNum">     139 </span>            : You also project vectors of differences of arguments on reference vectors.  For example, the input below can be used to look at the projection</a>
<a name="140"><span class="lineNum">     140 </span>            : of the vector connecting the instantanous configuraiton to a reference point in CV on a reference vector that has been specified in the PDB file.</a>
<a name="141"><span class="lineNum">     141 </span>            : </a>
<a name="142"><span class="lineNum">     142 </span>            : \plumedfile</a>
<a name="143"><span class="lineNum">     143 </span>            : d1: DISTANCE ATOMS=1,2</a>
<a name="144"><span class="lineNum">     144 </span>            : d2: DISTANCE ATOMS=3,4</a>
<a name="145"><span class="lineNum">     145 </span>            : d3: DISTANCE ATOMS=5,6</a>
<a name="146"><span class="lineNum">     146 </span>            : pca: PCAVARS ARG=d1,d2,d3 REFERENCE=epath.pdb</a>
<a name="147"><span class="lineNum">     147 </span>            : PRINT ARG=pca_eig-1,pca_residual FILE=colvar</a>
<a name="148"><span class="lineNum">     148 </span>            : \endplumedfile</a>
<a name="149"><span class="lineNum">     149 </span>            : </a>
<a name="150"><span class="lineNum">     150 </span>            : The pdb input file for this calculation might look something like this:</a>
<a name="151"><span class="lineNum">     151 </span>            : </a>
<a name="152"><span class="lineNum">     152 </span>            : \verbatim</a>
<a name="153"><span class="lineNum">     153 </span>            : REMARK d1=0.1221 d2=0.0979 d3=0.1079</a>
<a name="154"><span class="lineNum">     154 </span>            : END</a>
<a name="155"><span class="lineNum">     155 </span>            : REMARK d1=0.078811 d2=-0.945732 d3=-0.315244</a>
<a name="156"><span class="lineNum">     156 </span>            : END</a>
<a name="157"><span class="lineNum">     157 </span>            : \endverbatim</a>
<a name="158"><span class="lineNum">     158 </span>            : </a>
<a name="159"><span class="lineNum">     159 </span>            : The first set of argument values in this input file are the reference values for the arguments.  The second any subsquent sets of arguments give the</a>
<a name="160"><span class="lineNum">     160 </span>            : coefficients that should be used when constructing linear combinations.</a>
<a name="161"><span class="lineNum">     161 </span>            : </a>
<a name="162"><span class="lineNum">     162 </span>            : Notice, lastly, that you can also use a combination of argument values and atomic positions when specifying the reference configuration and the reference</a>
<a name="163"><span class="lineNum">     163 </span>            : directions.  If you are doing something this complicated, however, you are perhaps better working with the PLUMED input directly rather than this shortcut</a>
<a name="164"><span class="lineNum">     164 </span>            : as you will need to take special measures to ensure that all your CVs are in the same units.</a>
<a name="165"><span class="lineNum">     165 </span>            : </a>
<a name="166"><span class="lineNum">     166 </span>            : */</a>
<a name="167"><span class="lineNum">     167 </span>            : //+ENDPLUMEDOC</a>
<a name="168"><span class="lineNum">     168 </span>            : </a>
<a name="169"><span class="lineNum">     169 </span>            : class PCAVars : public ActionShortcut {</a>
<a name="170"><span class="lineNum">     170 </span>            : public:</a>
<a name="171"><span class="lineNum">     171 </span>            :   static void registerKeywords(Keywords&amp; keys);</a>
<a name="172"><span class="lineNum">     172 </span>            :   explicit PCAVars(const ActionOptions&amp;);</a>
<a name="173"><span class="lineNum">     173 </span>            : };</a>
<a name="174"><span class="lineNum">     174 </span>            : </a>
<a name="175"><span class="lineNum">     175 </span>            : </a>
<a name="176"><span class="lineNum">     176 </span>            : PLUMED_REGISTER_ACTION(PCAVars,&quot;PCAVARS&quot;)</a>
<a name="177"><span class="lineNum">     177 </span>            : </a>
<a name="178"><span class="lineNum">     178 </span><span class="lineCov">          9 : void PCAVars::registerKeywords( Keywords&amp; keys ) {</span></a>
<a name="179"><span class="lineNum">     179 </span><span class="lineCov">          9 :   ActionShortcut::registerKeywords( keys );</span></a>
<a name="180"><span class="lineNum">     180 </span><span class="lineCov">         18 :   keys.add(&quot;compulsory&quot;,&quot;REFERENCE&quot;,&quot;a pdb file containing the set of reference configurations&quot;);</span></a>
<a name="181"><span class="lineNum">     181 </span><span class="lineCov">         18 :   keys.add(&quot;compulsory&quot;,&quot;TYPE&quot;,&quot;OPTIMAL-FAST&quot;,&quot;the manner in which distances are calculated. More information on the different &quot;</span></a>
<a name="182"><span class="lineNum">     182 </span>            :            &quot;metrics that are available in PLUMED can be found in the section of the manual on &quot;</a>
<a name="183"><span class="lineNum">     183 </span>            :            &quot;\\ref dists&quot;);</a>
<a name="184"><span class="lineNum">     184 </span><span class="lineCov">         18 :   keys.add(&quot;optional&quot;,&quot;ARG&quot;,&quot;if there are arguments to be used specify them here&quot;);</span></a>
<a name="185"><span class="lineNum">     185 </span><span class="lineCov">         18 :   keys.addFlag(&quot;NOPBC&quot;,false,&quot;do not use periodic boundary conditions when computing this quantity&quot;);</span></a>
<a name="186"><span class="lineNum">     186 </span><span class="lineCov">         18 :   keys.addOutputComponent(&quot;eig&quot;,&quot;default&quot;,&quot;the projections on the eigenvalues&quot;);</span></a>
<a name="187"><span class="lineNum">     187 </span><span class="lineCov">         18 :   keys.addOutputComponent(&quot;residual&quot;,&quot;default&quot;,&quot;the residual distance that is not projected on any of the eigenvalues&quot;);</span></a>
<a name="188"><span class="lineNum">     188 </span><span class="lineCov">         27 :   keys.needsAction(&quot;RMSD&quot;); keys.needsAction(&quot;PDB2CONSTANT&quot;); keys.needsAction(&quot;TRANSPOSE&quot;);</span></a>
<a name="189"><span class="lineNum">     189 </span><span class="lineCov">         36 :   keys.needsAction(&quot;EUCLIDEAN_DISTANCE&quot;); keys.needsAction(&quot;CONCATENATE&quot;); keys.needsAction(&quot;COMBINE&quot;); keys.needsAction(&quot;CONSTANT&quot;);</span></a>
<a name="190"><span class="lineNum">     190 </span><span class="lineCov">         36 :   keys.needsAction(&quot;COMBINE&quot;); keys.needsAction(&quot;MATRIX_VECTOR_PRODUCT&quot;); keys.needsAction(&quot;CUSTOM&quot;); keys.needsAction(&quot;SUM&quot;);</span></a>
<a name="191"><span class="lineNum">     191 </span><span class="lineCov">          9 :   keys.needsAction(&quot;SELECT_COMPONENTS&quot;);</span></a>
<a name="192"><span class="lineNum">     192 </span><span class="lineCov">          9 : }</span></a>
<a name="193"><span class="lineNum">     193 </span>            : </a>
<a name="194"><span class="lineNum">     194 </span><span class="lineCov">          5 : PCAVars::PCAVars( const ActionOptions&amp; ao ):</span></a>
<a name="195"><span class="lineNum">     195 </span>            :   Action(ao),</a>
<a name="196"><span class="lineNum">     196 </span><span class="lineCov">          5 :   ActionShortcut(ao)</span></a>
<a name="197"><span class="lineNum">     197 </span>            : {</a>
<a name="198"><span class="lineNum">     198 </span><span class="lineCov">         10 :   std::string reference; parse(&quot;REFERENCE&quot;,reference);</span></a>
<a name="199"><span class="lineNum">     199 </span>            :   // Create the object that holds the atomic positions by reading the first frame</a>
<a name="200"><span class="lineNum">     200 </span><span class="lineCov">          5 :   FILE* fp=std::fopen(reference.c_str(),&quot;r&quot;); PDB pdb; if(!fp) error(&quot;could not open reference file &quot; + reference );</span></a>
<a name="201"><span class="lineNum">     201 </span><span class="lineCov">          5 :   bool do_read=pdb.readFromFilepointer(fp,false,0.1); if( !do_read ) plumed_merror(&quot;missing file &quot; + reference );</span></a>
<a name="202"><span class="lineNum">     202 </span><span class="lineCov">          5 :   std::string mtype; parse(&quot;TYPE&quot;,mtype);</span></a>
<a name="203"><span class="lineNum">     203 </span>            : </a>
<a name="204"><span class="lineNum">     204 </span><span class="lineCov">          5 :   if( pdb.getPositions().size()&gt;0 ) {</span></a>
<a name="205"><span class="lineNum">     205 </span>            :     // And now create the rmsd object</a>
<a name="206"><span class="lineNum">     206 </span><span class="lineCov">          3 :     std::string rmsd_line =  getShortcutLabel() + &quot;_at: RMSD DISPLACEMENT SQUARED NUMBER=1 REFERENCE=&quot; + reference;</span></a>
<a name="207"><span class="lineNum">     207 </span><span class="lineCov">          6 :     bool nopbc; parseFlag(&quot;NOPBC&quot;,nopbc); if(nopbc) rmsd_line += &quot; NOPBC&quot;;</span></a>
<a name="208"><span class="lineNum">     208 </span>            :     // Now create the RMSD object</a>
<a name="209"><span class="lineNum">     209 </span><span class="lineCov">          6 :     readInputLine( rmsd_line + &quot; TYPE=&quot; + mtype );</span></a>
<a name="210"><span class="lineNum">     210 </span>            :   }</a>
<a name="211"><span class="lineNum">     211 </span><span class="lineCov">         10 :   std::vector&lt;std::string&gt; argnames; parseVector(&quot;ARG&quot;,argnames); unsigned nargs=0; std::string instargs, refargs; std::vector&lt;Value*&gt; theargs;</span></a>
<a name="212"><span class="lineNum">     212 </span><span class="lineCov">          5 :   if( argnames.size()&gt;0 ) ActionWithArguments::interpretArgumentList( argnames, plumed.getActionSet(), this, theargs );</span></a>
<a name="213"><span class="lineNum">     213 </span><span class="lineCov">          9 :   for(unsigned i=0; i&lt;theargs.size(); ++i) {</span></a>
<a name="214"><span class="lineNum">     214 </span><span class="lineCov">          4 :     std::string iargn = Path::fixArgumentName( theargs[i]-&gt;getName() ); nargs += theargs[i]-&gt;getNumberOfValues();</span></a>
<a name="215"><span class="lineNum">     215 </span><span class="lineCov">          4 :     if( theargs[i]-&gt;getNumberOfValues()&gt;1 ) {</span></a>
<a name="216"><span class="lineNum">     216 </span><span class="lineCov">          2 :       readInputLine( getShortcutLabel() + &quot;_ref_&quot; + iargn + &quot;T: PDB2CONSTANT NUMBER=1 REFERENCE=&quot; + reference + &quot; ARG=&quot; + theargs[i]-&gt;getName() );</span></a>
<a name="217"><span class="lineNum">     217 </span><span class="lineCov">          2 :       readInputLine( getShortcutLabel() + &quot;_ref_&quot; + iargn + &quot;: TRANSPOSE ARG=&quot; + getShortcutLabel() + &quot;_ref_&quot; + iargn + &quot;T&quot;);</span></a>
<a name="218"><span class="lineNum">     218 </span><span class="lineCov">          6 :     } else readInputLine( getShortcutLabel() + &quot;_ref_&quot; + iargn + &quot;: PDB2CONSTANT NUMBER=1 REFERENCE=&quot; + reference + &quot; ARG=&quot; + theargs[i]-&gt;getName() );</span></a>
<a name="219"><span class="lineNum">     219 </span><span class="lineCov">          8 :     if( i==0 ) { instargs=&quot; ARG1=&quot; + theargs[i]-&gt;getName(); refargs=&quot; ARG2=&quot; + getShortcutLabel() + &quot;_ref_&quot; + iargn; }</span></a>
<a name="220"><span class="lineNum">     220 </span><span class="lineCov">          6 :     else { instargs +=&quot;,&quot; + theargs[i]-&gt;getName(); refargs +=&quot;,&quot; + getShortcutLabel() + &quot;_ref_&quot; + iargn; }</span></a>
<a name="221"><span class="lineNum">     221 </span>            :   }</a>
<a name="222"><span class="lineNum">     222 </span><span class="lineCov">          7 :   if( theargs.size()&gt;0 ) readInputLine( getShortcutLabel() + &quot;_argdist: EUCLIDEAN_DISTANCE SQUARED&quot; + instargs + refargs );</span></a>
<a name="223"><span class="lineNum">     223 </span><span class="lineCov">          5 :   if( pdb.getPositions().size()&gt;0 &amp;&amp; theargs.size()&gt;0 ) {</span></a>
<a name="224"><span class="lineNum">     224 </span><span class="lineNoCov">          0 :     readInputLine( getShortcutLabel() + &quot;: CONCATENATE ARG=&quot; + getShortcutLabel() + &quot;_at.disp,&quot; + getShortcutLabel() + &quot;_argdist_diffT&quot;);</span></a>
<a name="225"><span class="lineNum">     225 </span><span class="lineNoCov">          0 :     readInputLine( getShortcutLabel() + &quot;_dist: COMBINE ARG=&quot; + getShortcutLabel() + &quot;_at.dist,&quot; + getShortcutLabel() + &quot;_argdist PERIODIC=NO&quot;);</span></a>
<a name="226"><span class="lineNum">     226 </span>            :   }</a>
<a name="227"><span class="lineNum">     227 </span>            : </a>
<a name="228"><span class="lineNum">     228 </span>            :   // Get the displace stuff</a>
<a name="229"><span class="lineNum">     229 </span><span class="lineCov">          5 :   std::vector&lt;double&gt; displace( pdb.getBeta() ); double dtot = 0;</span></a>
<a name="230"><span class="lineNum">     230 </span><span class="lineCov">         26 :   for(unsigned i=0; i&lt;displace.size(); ++i) dtot += displace[i];</span></a>
<a name="231"><span class="lineNum">     231 </span><span class="lineCov">         26 :   for(unsigned i=0; i&lt;displace.size(); ++i) displace[i] = displace[i] / dtot;</span></a>
<a name="232"><span class="lineNum">     232 </span>            : </a>
<a name="233"><span class="lineNum">     233 </span>            :   // Now read in the directions and create matheval objects to compute the pca components</a>
<a name="234"><span class="lineNum">     234 </span><span class="lineCov">          5 :   unsigned nfram=0, ncomp=0; std::string pvec;</span></a>
<a name="235"><span class="lineNum">     235 </span><span class="lineCov">         13 :   while( do_read ) {</span></a>
<a name="236"><span class="lineNum">     236 </span><span class="lineCov">         13 :     std::vector&lt;double&gt; argdir(nargs); PDB mypdb; do_read=mypdb.readFromFilepointer(fp,plumed.usingNaturalUnits(),0.1/plumed.getUnits().getLength());</span></a>
<a name="237"><span class="lineNum">     237 </span><span class="lineCov">         13 :     if( do_read ) {</span></a>
<a name="238"><span class="lineNum">     238 </span><span class="lineCov">          8 :       nfram++;</span></a>
<a name="239"><span class="lineNum">     239 </span>            :       // Normalize the eigenvector in the input</a>
<a name="240"><span class="lineNum">     240 </span>            :       double norm=0;</a>
<a name="241"><span class="lineNum">     241 </span><span class="lineCov">         50 :       for(unsigned i=0; i&lt;mypdb.getPositions().size(); ++i) {</span></a>
<a name="242"><span class="lineNum">     242 </span><span class="lineCov">         42 :         norm += mypdb.getPositions()[i][0]*mypdb.getPositions()[i][0];</span></a>
<a name="243"><span class="lineNum">     243 </span><span class="lineCov">         42 :         norm += mypdb.getPositions()[i][1]*mypdb.getPositions()[i][1];</span></a>
<a name="244"><span class="lineNum">     244 </span><span class="lineCov">         42 :         norm += mypdb.getPositions()[i][2]*mypdb.getPositions()[i][2];</span></a>
<a name="245"><span class="lineNum">     245 </span>            :       }</a>
<a name="246"><span class="lineNum">     246 </span>            :       unsigned k=0;</a>
<a name="247"><span class="lineNum">     247 </span><span class="lineCov">         12 :       for(unsigned i=0; i&lt;theargs.size(); ++i) {</span></a>
<a name="248"><span class="lineNum">     248 </span><span class="lineCov">          4 :         std::vector&lt;double&gt; argval( theargs[i]-&gt;getNumberOfValues() );</span></a>
<a name="249"><span class="lineNum">     249 </span><span class="lineCov">          4 :         if( !mypdb.getArgumentValue(theargs[i]-&gt;getName(), argval) ) error(&quot;argument &quot; + theargs[i]-&gt;getName() + &quot; was not set in pdb input&quot;);</span></a>
<a name="250"><span class="lineNum">     250 </span><span class="lineCov">         10 :         for(unsigned j=0; j&lt;argval.size(); ++j) { argdir[k] = argval[j]; norm += argdir[k]*argdir[k]; k++; }</span></a>
<a name="251"><span class="lineNum">     251 </span>            :       }</a>
<a name="252"><span class="lineNum">     252 </span><span class="lineCov">          8 :       norm = sqrt( norm ); std::vector&lt;double&gt; normed_coeffs( 3*mypdb.getPositions().size() );</span></a>
<a name="253"><span class="lineNum">     253 </span><span class="lineCov">         50 :       for(unsigned i=0; i&lt;mypdb.getPositions().size(); ++i) {</span></a>
<a name="254"><span class="lineNum">     254 </span><span class="lineCov">         42 :         if( mtype==&quot;SIMPLE&quot; ) {</span></a>
<a name="255"><span class="lineNum">     255 </span><span class="lineCov">         28 :           normed_coeffs[0*mypdb.getPositions().size()+i] = mypdb.getPositions()[i][0] / norm;</span></a>
<a name="256"><span class="lineNum">     256 </span><span class="lineCov">         28 :           normed_coeffs[1*mypdb.getPositions().size()+i] = mypdb.getPositions()[i][1] / norm;</span></a>
<a name="257"><span class="lineNum">     257 </span><span class="lineCov">         28 :           normed_coeffs[2*mypdb.getPositions().size()+i] = mypdb.getPositions()[i][2] / norm;</span></a>
<a name="258"><span class="lineNum">     258 </span>            :         } else {</a>
<a name="259"><span class="lineNum">     259 </span><span class="lineCov">         14 :           normed_coeffs[0*mypdb.getPositions().size()+i] = sqrt(displace[i])*mypdb.getPositions()[i][0] / norm;</span></a>
<a name="260"><span class="lineNum">     260 </span><span class="lineCov">         14 :           normed_coeffs[1*mypdb.getPositions().size()+i] = sqrt(displace[i])*mypdb.getPositions()[i][1] / norm;</span></a>
<a name="261"><span class="lineNum">     261 </span><span class="lineCov">         14 :           normed_coeffs[2*mypdb.getPositions().size()+i] = sqrt(displace[i])*mypdb.getPositions()[i][2] / norm;</span></a>
<a name="262"><span class="lineNum">     262 </span>            :         }</a>
<a name="263"><span class="lineNum">     263 </span>            :       }</a>
<a name="264"><span class="lineNum">     264 </span>            :       std::string coeff1;</a>
<a name="265"><span class="lineNum">     265 </span><span class="lineCov">          8 :       if( mypdb.getPositions().size()&gt;0 ) {</span></a>
<a name="266"><span class="lineNum">     266 </span><span class="lineCov">          6 :         if( nfram==1 ) Tools::convert( normed_coeffs[0], pvec );</span></a>
<a name="267"><span class="lineNum">     267 </span><span class="lineCov">          6 :         else { Tools::convert( normed_coeffs[0], coeff1 ); pvec += &quot;,&quot; + coeff1; }</span></a>
<a name="268"><span class="lineNum">     268 </span><span class="lineCov">        126 :         for(unsigned i=1; i&lt;normed_coeffs.size(); ++i) {</span></a>
<a name="269"><span class="lineNum">     269 </span><span class="lineCov">        120 :           Tools::convert( normed_coeffs[i], coeff1 );</span></a>
<a name="270"><span class="lineNum">     270 </span><span class="lineCov">        240 :           pvec += &quot;,&quot; + coeff1;</span></a>
<a name="271"><span class="lineNum">     271 </span>            :         }</a>
<a name="272"><span class="lineNum">     272 </span><span class="lineCov">          6 :         for(unsigned i=0; i&lt;argdir.size(); ++i) { Tools::convert( argdir[i] / norm, coeff1 ); pvec += &quot;,&quot; + coeff1; }</span></a>
<a name="273"><span class="lineNum">     273 </span><span class="lineCov">          2 :       } else if( theargs.size()&gt;0 ) {</span></a>
<a name="274"><span class="lineNum">     274 </span><span class="lineCov">          2 :         if( nfram==1 ) Tools::convert( argdir[0] / norm, pvec );</span></a>
<a name="275"><span class="lineNum">     275 </span><span class="lineNoCov">          0 :         else { Tools::convert( argdir[0] / norm, coeff1 ); pvec += &quot;,&quot; + coeff1; }</span></a>
<a name="276"><span class="lineNum">     276 </span><span class="lineCov">          6 :         for(unsigned i=1; i&lt;argdir.size(); ++i) { Tools::convert( argdir[i] / norm, coeff1 ); pvec += &quot;,&quot; + coeff1; }</span></a>
<a name="277"><span class="lineNum">     277 </span>            :       }</a>
<a name="278"><span class="lineNum">     278 </span><span class="lineCov">          8 :       ncomp = 3*mypdb.getPositions().size() + nargs;</span></a>
<a name="279"><span class="lineNum">     279 </span>            :     } else { break; }</a>
<a name="280"><span class="lineNum">     280 </span><span class="lineCov">         13 :   }</span></a>
<a name="281"><span class="lineNum">     281 </span><span class="lineCov">          5 :   std::fclose(fp); std::string neig, ncols; Tools::convert( nfram, neig ); Tools::convert( ncomp, ncols );</span></a>
<a name="282"><span class="lineNum">     282 </span><span class="lineCov">         10 :   readInputLine( getShortcutLabel() + &quot;_peig: CONSTANT VALUES=&quot; + pvec + &quot; NROWS=&quot; + neig + &quot; NCOLS=&quot; + ncols );</span></a>
<a name="283"><span class="lineNum">     283 </span><span class="lineCov">          5 :   if( pdb.getPositions().size()&gt;0 &amp;&amp; theargs.size()&gt;0 ) readInputLine( getShortcutLabel() + &quot;_eig: MATRIX_VECTOR_PRODUCT ARG=&quot; + getShortcutLabel() + &quot;_peig,&quot; + getShortcutLabel() );</span></a>
<a name="284"><span class="lineNum">     284 </span><span class="lineCov">          8 :   else if( pdb.getPositions().size()&gt;0 ) readInputLine( getShortcutLabel() + &quot;_eig: MATRIX_VECTOR_PRODUCT ARG=&quot; + getShortcutLabel() + &quot;_peig,&quot; + getShortcutLabel() + &quot;_at.disp&quot;);</span></a>
<a name="285"><span class="lineNum">     285 </span><span class="lineCov">          4 :   else if( theargs.size()&gt;0 ) readInputLine( getShortcutLabel() + &quot;_eig: MATRIX_VECTOR_PRODUCT ARG=&quot; + getShortcutLabel() + &quot;_peig,&quot; + getShortcutLabel() + &quot;_argdist_diffT&quot;);</span></a>
<a name="286"><span class="lineNum">     286 </span><span class="lineCov">         13 :   for(unsigned i=0; i&lt;nfram; ++i) {</span></a>
<a name="287"><span class="lineNum">     287 </span><span class="lineCov">          8 :     std::string num; Tools::convert( i+1, num );</span></a>
<a name="288"><span class="lineNum">     288 </span><span class="lineCov">         16 :     readInputLine( getShortcutLabel() + &quot;_eig-&quot; + num + &quot;: SELECT_COMPONENTS ARG=&quot; + getShortcutLabel() + &quot;_eig COMPONENTS=&quot; + num );</span></a>
<a name="289"><span class="lineNum">     289 </span>            :   }</a>
<a name="290"><span class="lineNum">     290 </span><span class="lineCov">         10 :   readInputLine( getShortcutLabel() + &quot;_eig2: CUSTOM ARG=&quot; + getShortcutLabel() + &quot;_eig FUNC=x*x PERIODIC=NO&quot;);</span></a>
<a name="291"><span class="lineNum">     291 </span><span class="lineCov">         10 :   readInputLine( getShortcutLabel() + &quot;_eigsum2: SUM ARG=&quot; +  getShortcutLabel() + &quot;_eig2 PERIODIC=NO&quot;);</span></a>
<a name="292"><span class="lineNum">     292 </span><span class="lineCov">          5 :   if( pdb.getPositions().size()&gt;0 &amp;&amp; theargs.size()&gt;0 ) readInputLine( getShortcutLabel() + &quot;_residual: CUSTOM ARG=&quot; + getShortcutLabel() + &quot;_dist,&quot; + getShortcutLabel() + &quot;_eigsum2 FUNC=sqrt(x-y) PERIODIC=NO&quot;);</span></a>
<a name="293"><span class="lineNum">     293 </span><span class="lineCov">          8 :   else if( pdb.getPositions().size()&gt;0 ) readInputLine( getShortcutLabel() + &quot;_residual: CUSTOM ARG=&quot; + getShortcutLabel() + &quot;_at.dist,&quot; + getShortcutLabel() + &quot;_eigsum2 FUNC=sqrt(x-y) PERIODIC=NO&quot;);</span></a>
<a name="294"><span class="lineNum">     294 </span><span class="lineCov">          4 :   else if( theargs.size()&gt;0 ) readInputLine( getShortcutLabel() + &quot;_residual: CUSTOM ARG=&quot; + getShortcutLabel() + &quot;_argdist,&quot; + getShortcutLabel() + &quot;_eigsum2 FUNC=sqrt(x-y) PERIODIC=NO&quot;);</span></a>
<a name="295"><span class="lineNum">     295 </span><span class="lineCov">         15 : }</span></a>
<a name="296"><span class="lineNum">     296 </span>            : </a>
<a name="297"><span class="lineNum">     297 </span>            : }</a>
<a name="298"><span class="lineNum">     298 </span>            : }</a>
<a name="299"><span class="lineNum">     299 </span>            : </a>
<a name="300"><span class="lineNum">     300 </span>            : </a>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="https://github.com/linux-test-project/lcov" target="_parent">LCOV version 1.16</a></td></tr>
  </table>
  <br>

</body>
</html>
